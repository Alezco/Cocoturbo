version: 2

jobs:
  build:
    docker:
      - image: notnoopci/php:7.1.5-browsers
      - image: circleci/openjdk:8-jdk-browsers
    working_directory: ~/laravel
    steps:
      - checkout
      - run: sudo apt install -y libsqlite3-dev
      - run: composer self-update
      - restore_cache:
          keys:
            - composer-v1-{{ checksum "composer.json" }}
            - composer-v1-
      - run: composer install -n --prefer-dist
      - save_cache:
          key: composer-v1-{{ checksum "composer.json" }}
          paths:
            - vendor
      - run: touch storage/testing.sqlite
      - run: touch database/database.sqlite
      - run: cp .env.testing .env
      - run: php artisan migrate --env=testing --database=sqlite --force
      - run: php artisan db:seed --env=testing --database=sqlite --force
      - run: cat database/database.sqlite
      - run: cat storage/testing.sqlite
      - run: ./vendor/bin/phpunit
      - run: unzip jmeter/apache-jmeter-3.2.zip
      - run: sudo apt-get install default-jre
      - run: sudo apt-get install python-software-properties software-properties-common
      - run: sudo add-apt-repository ppa:webupd8team/java
      - run: sudo echo "deb http://ppa.launchpad.net/webupd8team/java/ubuntu xenial main" | tee /etc/apt/sources.list.d/webupd8team-java.list
      - run: sudo echo "deb-src http://ppa.launchpad.net/webupd8team/java/ubuntu xenial main" | tee -a /etc/apt/sources.list.d/webupd8team-java.list
      - run: sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys EEA14886
      - run: sudo apt-get update
      - run: sudo apt-get install oracle-java8-installer
      - run: sudo apt-get update
      - run: sudo apt-get install oracle-java8-installer
      - run: java -version
      - run: sudo update-alternatives --config java
      - run: ./apache-jmeter-3.2/bin/jmeter coco.jmx